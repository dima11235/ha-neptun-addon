# Neptun Local Bridge (Home Assistant add-on)

Мини-аддон, который поднимает локальный Mosquitto без аутентификации и парсит пакеты Neptun, а затем бриджит нужные топики в стандартный MQTT Home Assistant с аутентификацией. Сущности в HA создаются через MQTT Discovery.

Что делает аддон
- Поднимает локальный MQTT на настраиваемом порту (по умолчанию 2883), без аутентификации.
- Принимает кадры от Neptun в `CLOUD_PREFIX/<MAC>/from` и публикует разобранные данные в `TOPIC_PREFIX/<MAC>/...`.
- Через Mosquitto bridge пересылает в HA брокер Discovery и состояния; команды из HA возвращает на локальный брокер.
- Создает в HA: переключатель клапана, датчики протечки и показания счетчиков (в т.ч. литры) через MQTT Discovery.

Установка
- Добавьте репозиторий аддонов и установите “Neptun Local Bridge”.
- В конфигурации аддона укажите параметры (см. ниже). Обычно достаточно задать учетные данные HA MQTT.
- Запустите аддон. Сущности появятся автоматически (MQTT Discovery должно быть включено в HA).
- Перенаправьте исходящее подключение устройства Neptun к облаку на локальный брокер аддона.
  Трафик на `185.76.147.189:1883` (облачный MQTT) должен уходить на `IP_HA:<listen_port>` (по умолчанию `2883`).
  Пример для Keenetic (CLI), где `10.77.11.200` — IP Home Assistant в вашей сети:
```
ip static tcp 185.76.147.189/32 1883 192.168.1.200 2883
system configuration save
```
- Убедитесь, что:
  - адрес IP_HA указан корректно и доступен из подсети устройства Neptun;
  - порт совпадает с `mqtt.listen_port` в настройках аддона (если меняли дефолт 2883 — используйте его);
  - правило применяется для исходящего трафика устройства (иногда нужно включить hairpin/loopback NAT или правила policy?based NAT).

Параметры (options)
```
mqtt:
  listen_port: 2883          # Порт локального брокера внутри аддона
  allow_anonymous: true      # Разрешить анонимные подключения (по умолчанию true)
  user: ""                   # Опционально: пользователь локального брокера
  password: ""               # Опционально: пароль локального брокера
ha_mqtt:
  host: core-mosquitto       # Брокер HA (по умолчанию core-mosquitto)
  port: 1883                 # Порт брокера HA
  user: "!secret mqtt_username"  # Пользователь HA MQTT (поддерживается !secret)
  password: "!secret mqtt_password"  # Пароль HA MQTT (поддерживается !secret)
bridge:
  cloud_prefix: ""           # Пусто — автодискавери; если указано — используется принудительно
  topic_prefix: "neptun"     # Префикс публикаций состояния/команд
  discovery_prefix: "homeassistant"  # Префикс MQTT Discovery
  retain: true               # Retain по умолчанию для публикаций
  debug: false               # Дополнительный лог в stderr
```

Автообнаружение
- При `cloud_prefix: ""` аддон подписывается на `+/+/from` и автоматически определяет cloud-префикс и MAC по первому входящему сообщению (`<prefix>/<MAC>/from`).
- Команды в устройство отправляются на `<prefix>/<MAC>/to`. Если префикс еще не обнаружен (не было входящих сообщений) — команда будет пропущена до появления первого кадра.
- Если хотите отправлять команды сразу, задайте `cloud_prefix` явно — тогда будет использоваться только он.

Secrets
- В полях `mqtt.user/password` и `ha_mqtt.user/password` можно использовать `!secret KEY`.
- Значения читаются из файла `/config/secrets.yaml` (через Supervisor у аддона есть доступ к `/config`).
- Дополнительно поддерживается единая запись `mqtt_server: mqtt://<host>:<port>` — при наличии переопределяет `ha_mqtt.host/port`.
- Пример `secrets.yaml`:
```
mqtt_username: myuser
mqtt_password: mypass
mqtt_server: mqtt://core-mosquitto:1883
```

Сетевое взаимодействие
- Локальный Mosquitto слушает `listen_port` (по умолчанию 2883) внутри контейнера аддона.
- Бридж в HA настраивается автоматически при наличии `ha_mqtt.user/password` и публикует:
  - Исходящие в HA: `<topic_prefix>/#` и `<discovery_prefix>/#`.
  - Входящие из HA в локальный: `<topic_prefix>/+/cmd/#` (команды для устройства).
- Рекомендуемый хост HA MQTT: `core-mosquitto`; порт: `1883`.

Основные топики
- Вход устройства: `CLOUD_PREFIX/<MAC>/from` (сырые кадры Neptun).
- Публикации состояния: `TOPIC_PREFIX/<MAC>/**` (сенсоры, счетчики, состояния).
- Команды из HA: `TOPIC_PREFIX/<MAC>/cmd/valve/set` со значениями `1/0` (`ON/OFF`, `OPEN/CLOSE`).
- MQTT Discovery публикуется под `DISCOVERY_PREFIX/**`.

Примечания
- Для работы без стороннего брокера устройство Neptun должно уметь подключаться к локальному брокеру аддона.
- Если локальный брокер нужно защитить, задайте `mqtt.user/password` и `allow_anonymous: false`.
- Отладка: включите `bridge.debug: true` — аддон начнет печатать подробные сообщения в лог.



## Дополнения к функциональности (актуально для 0.1.45)

Ниже перечислено, что добавлено/уточнено по сравнению с ранними версиями. Эти пункты не меняют порядок установки и общие принципы работы, а дополняют их.

- Управление (HA entities):
  - Переключатель клапана `Valve` (cmd `neptun/<MAC>/cmd/valve/set`, state `neptun/<MAC>/state/valve_open`).
  - Переключатель `Floor Wash` (бывший Dry Flag) — включает/выключает сухой режим контроллера (cmd `.../cmd/dry_flag/set`, state `.../settings/dry_flag`).
  - Переключатель `Close On Offline` — закрывать кран при потере датчиков (cmd `.../cmd/close_on_offline/set`, state `.../settings/close_valve_flag`).
  - Селект `Line i Type (1..4)` — тип входа линии (sensor/counter) (cmd `.../cmd/line_i_type/set`, state `.../settings/lines_in/line_i`).
  - Числовые поля (mode=box):
    - `Line i Counter (set)` — установка счётчика в литрах (cmd `.../cmd/counters/line_i/value/set`).
    - `Line i Step (set)` — шаг в L/импульс (cmd `.../cmd/counters/line_i/step/set`).

- Сенсоры:
  - `Module Status` (текстовое описание статуса модуля) — `neptun/<MAC>/state/status_name`.
  - `Module Alert` (binary, device_class: problem) — включается при любом проблемном бите статуса — `neptun/<MAC>/settings/status/module_alert` (yes/no).
  - `Device Time` (timestamp) — время контроллера из TLV 0x44; публикуется как ISO UTC с учётом локального часового пояса.
  - `Device Time Drift` (diagnostic) — разница между локальными часами хоста и временем устройства, сек — `neptun/<MAC>/device_time_drift_seconds`.
  - `Module Lost` (binary, problem) — yes, если не было данных более 120 секунд. Предпочтительно используется время из TLV 0x44; при его отсутствии — время получения кадра.

- Протокол/обработка:
  - Поддерживаются кадры 0x52 (system_state), 0x53 (sensor_state), 0x57 (settings), 0x43 (counters).
  - TLV 0x44 — время устройства: приходит в локальном времени; конвертируем в UTC, публикуем ISO и epoch, считаем дрейф.
  - Батарея беспроводных датчиков: значения > 200 (похоже на «вольтовую шкалу») отбрасываются и не публикуются; валидные проценты 0..100 — публикуются.
  - Запись счётчиков: формируется кадр 0x57/0x43 на `<cloud_prefix>/<MAC>/to`; для не изменяемых линий подставляются последние известные «сырые» значения/шаги.

- Диагностика:
  - Включение `NB_DEBUG=true` добавляет расширенные логи подписки/публикаций.
  - «Raw» кадры публикуются в `neptun/<MAC>/raw/*`, а также сгруппированы по типу и имени (`raw/by_type/*`, `raw/by_name/*`).

> Важно: настройка Wi?Fi самого Neptun не производится через MQTT. Используйте штатное приложение/режим точки доступа.

## Краткая история изменений

- 0.1.45 — корректная обработка `device_time` как локального времени; исправлен deprecation `utcfromtimestamp`.
- 0.1.44 — добавлены сенсоры `Module Status` (текст) и `Module Alert` (binary).
- 0.1.41–0.1.43 — `Module Lost`, парсинг TLV 0x44 (время), `Device Time Drift` и сопутствующие улучшения.
- 0.1.36–0.1.39 — единый переключатель `Valve`, переименование Dry Flag > `Floor Wash`, числовые поля ввода для счётчика и шага.

