# Neptun ProW+WiFi Local Bridge (Home Assistant add-on)

Р”РѕРїРѕР»РЅРµРЅРёРµ РґР»СЏ РёРЅС‚РµРіСЂР°С†РёРё Neptun ProW+WiFi c Home Assistant.
Р”РѕРїРѕР»РЅРµРЅРёРµ РїРѕРґРЅРёРјР°РµС‚ Р»РѕРєР°Р»СЊРЅС‹Р№ Mosquitto Р±РµР· Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё, РїР°СЂСЃРёС‚ РїР°РєРµС‚С‹ Neptun, Р° Р·Р°С‚РµРј СЃРѕР·РґР°РµС‚ РЅСѓР¶РЅС‹Рµ С‚РѕРїРёРєРё РІ СЃС‚Р°РЅРґР°СЂС‚РЅРѕРј MQTT Home Assistant СЃ Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРµР№.
РЎСѓС‰РЅРѕСЃС‚Рё РІ HA СЃРѕР·РґР°СЋС‚СЃСЏ С‡РµСЂРµР· MQTT Discovery.

Р§С‚Рѕ РґРµР»Р°РµС‚ РґРѕРїРѕР»РЅРµРЅРёРµ
- РџРѕРґРЅРёРјР°РµС‚ Р»РѕРєР°Р»СЊРЅС‹Р№ MQTT РЅР° РЅР°СЃС‚СЂР°РёРІР°РµРјРѕРј РїРѕСЂС‚Сѓ (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ 2883), Р±РµР· Р°СѓС‚РµРЅС‚РёС„РёРєР°С†РёРё.
- РџСЂРёРЅРёРјР°РµС‚ РєР°РґСЂС‹ РѕС‚ Neptun РІ `CLOUD_PREFIX/<MAC>/from` Рё РїСѓР±Р»РёРєСѓРµС‚ СЂР°Р·РѕР±СЂР°РЅРЅС‹Рµ РґР°РЅРЅС‹Рµ РІ `TOPIC_PREFIX/<MAC>/...`.
- Р§РµСЂРµР· Mosquitto bridge РїРµСЂРµСЃС‹Р»Р°РµС‚ РІ HA Р±СЂРѕРєРµСЂ Discovery Рё СЃРѕСЃС‚РѕСЏРЅРёСЏ; РєРѕРјР°РЅРґС‹ РёР· HA РІРѕР·РІСЂР°С‰Р°РµС‚ РЅР° Р»РѕРєР°Р»СЊРЅС‹Р№ Р±СЂРѕРєРµСЂ.
- РЎРѕР·РґР°РµС‚ РІ HA: РїРµСЂРµРєР»СЋС‡Р°С‚РµР»СЊ РєР»Р°РїР°РЅР°, РґР°С‚С‡РёРєРё РїСЂРѕС‚РµС‡РєРё Рё РїРѕРєР°Р·Р°РЅРёСЏ СЃС‡РµС‚С‡РёРєРѕРІ (РІ С‚.С‡. Р»РёС‚СЂС‹) С‡РµСЂРµР· MQTT Discovery.

РЈСЃС‚Р°РЅРѕРІРєР°
- Р”РѕР±Р°РІСЊС‚Рµ СЂРµРїРѕР·РёС‚РѕСЂРёР№ Р°РґРґРѕРЅРѕРІ Рё СѓСЃС‚Р°РЅРѕРІРёС‚Рµ вЂњNeptun Local BridgeвЂќ.
- Р’ РєРѕРЅС„РёРіСѓСЂР°С†РёРё Р°РґРґРѕРЅР° СѓРєР°Р¶РёС‚Рµ РїР°СЂР°РјРµС‚СЂС‹ (СЃРј. РЅРёР¶Рµ). РћР±С‹С‡РЅРѕ РґРѕСЃС‚Р°С‚РѕС‡РЅРѕ Р·Р°РґР°С‚СЊ СѓС‡РµС‚РЅС‹Рµ РґР°РЅРЅС‹Рµ HA MQTT.
- Р—Р°РїСѓСЃС‚РёС‚Рµ Р°РґРґРѕРЅ. РЎСѓС‰РЅРѕСЃС‚Рё РїРѕСЏРІСЏС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё (MQTT Discovery РґРѕР»Р¶РЅРѕ Р±С‹С‚СЊ РІРєР»СЋС‡РµРЅРѕ РІ HA).
- РџРµСЂРµРЅР°РїСЂР°РІСЊС‚Рµ РёСЃС…РѕРґСЏС‰РµРµ РїРѕРґРєР»СЋС‡РµРЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР° Neptun Рє РѕР±Р»Р°РєСѓ РЅР° Р»РѕРєР°Р»СЊРЅС‹Р№ Р±СЂРѕРєРµСЂ Р°РґРґРѕРЅР°.
  РўСЂР°С„РёРє РЅР° `185.76.147.189:1883` (РѕР±Р»Р°С‡РЅС‹Р№ MQTT) РґРѕР»Р¶РµРЅ СѓС…РѕРґРёС‚СЊ РЅР° `IP_HA:<listen_port>` (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ `2883`).
  РџСЂРёРјРµСЂ РґР»СЏ Keenetic (CLI), РіРґРµ `10.77.11.200` вЂ” IP Home Assistant РІ РІР°С€РµР№ СЃРµС‚Рё:
```
ip static tcp 185.76.147.189/32 1883 192.168.1.200 2883
system configuration save
```
- РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ:
  - Р°РґСЂРµСЃ IP_HA СѓРєР°Р·Р°РЅ РєРѕСЂСЂРµРєС‚РЅРѕ Рё РґРѕСЃС‚СѓРїРµРЅ РёР· РїРѕРґСЃРµС‚Рё СѓСЃС‚СЂРѕР№СЃС‚РІР° Neptun;
  - РїРѕСЂС‚ СЃРѕРІРїР°РґР°РµС‚ СЃ `mqtt.listen_port` РІ РЅР°СЃС‚СЂРѕР№РєР°С… Р°РґРґРѕРЅР° (РµСЃР»Рё РјРµРЅСЏР»Рё РґРµС„РѕР»С‚ 2883 вЂ” РёСЃРїРѕР»СЊР·СѓР№С‚Рµ РµРіРѕ);
  - РїСЂР°РІРёР»Рѕ РїСЂРёРјРµРЅСЏРµС‚СЃСЏ РґР»СЏ РёСЃС…РѕРґСЏС‰РµРіРѕ С‚СЂР°С„РёРєР° СѓСЃС‚СЂРѕР№СЃС‚РІР° (РёРЅРѕРіРґР° РЅСѓР¶РЅРѕ РІРєР»СЋС‡РёС‚СЊ hairpin/loopback NAT РёР»Рё РїСЂР°РІРёР»Р° policyвЂ‘based NAT).

РџР°СЂР°РјРµС‚СЂС‹ (options)
```
mqtt:
  listen_port: 2883          # РџРѕСЂС‚ Р»РѕРєР°Р»СЊРЅРѕРіРѕ Р±СЂРѕРєРµСЂР° РІРЅСѓС‚СЂРё Р°РґРґРѕРЅР°
  allow_anonymous: true      # Р Р°Р·СЂРµС€РёС‚СЊ Р°РЅРѕРЅРёРјРЅС‹Рµ РїРѕРґРєР»СЋС‡РµРЅРёСЏ (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ true)
  user: ""                   # РћРїС†РёРѕРЅР°Р»СЊРЅРѕ: РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р»РѕРєР°Р»СЊРЅРѕРіРѕ Р±СЂРѕРєРµСЂР°
  password: ""               # РћРїС†РёРѕРЅР°Р»СЊРЅРѕ: РїР°СЂРѕР»СЊ Р»РѕРєР°Р»СЊРЅРѕРіРѕ Р±СЂРѕРєРµСЂР°
ha_mqtt:
  host: core-mosquitto       # Р‘СЂРѕРєРµСЂ HA (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ core-mosquitto)
  port: 1883                 # РџРѕСЂС‚ Р±СЂРѕРєРµСЂР° HA
  user: "!secret mqtt_username"  # РџРѕР»СЊР·РѕРІР°С‚РµР»СЊ HA MQTT (РїРѕРґРґРµСЂР¶РёРІР°РµС‚СЃСЏ !secret)
  password: "!secret mqtt_password"  # РџР°СЂРѕР»СЊ HA MQTT (РїРѕРґРґРµСЂР¶РёРІР°РµС‚СЃСЏ !secret)
bridge:
  cloud_prefix: ""           # РџСѓСЃС‚Рѕ вЂ” Р°РІС‚РѕРґРёСЃРєР°РІРµСЂРё; РµСЃР»Рё СѓРєР°Р·Р°РЅРѕ вЂ” РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РїСЂРёРЅСѓРґРёС‚РµР»СЊРЅРѕ
  topic_prefix: "neptun"     # РџСЂРµС„РёРєСЃ РїСѓР±Р»РёРєР°С†РёР№ СЃРѕСЃС‚РѕСЏРЅРёСЏ/РєРѕРјР°РЅРґ
  discovery_prefix: "homeassistant"  # РџСЂРµС„РёРєСЃ MQTT Discovery
  retain: true               # Retain РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ РґР»СЏ РїСѓР±Р»РёРєР°С†РёР№
  debug: false               # Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Р№ Р»РѕРі РІ stderr
```

РђРІС‚РѕРѕР±РЅР°СЂСѓР¶РµРЅРёРµ
- РџСЂРё `cloud_prefix: ""` Р°РґРґРѕРЅ РїРѕРґРїРёСЃС‹РІР°РµС‚СЃСЏ РЅР° `+/+/from` Рё Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РѕРїСЂРµРґРµР»СЏРµС‚ cloud-РїСЂРµС„РёРєСЃ Рё MAC РїРѕ РїРµСЂРІРѕРјСѓ РІС…РѕРґСЏС‰РµРјСѓ СЃРѕРѕР±С‰РµРЅРёСЋ (`<prefix>/<MAC>/from`).
- РљРѕРјР°РЅРґС‹ РІ СѓСЃС‚СЂРѕР№СЃС‚РІРѕ РѕС‚РїСЂР°РІР»СЏСЋС‚СЃСЏ РЅР° `<prefix>/<MAC>/to`. Р•СЃР»Рё РїСЂРµС„РёРєСЃ РµС‰Рµ РЅРµ РѕР±РЅР°СЂСѓР¶РµРЅ (РЅРµ Р±С‹Р»Рѕ РІС…РѕРґСЏС‰РёС… СЃРѕРѕР±С‰РµРЅРёР№) вЂ” РєРѕРјР°РЅРґР° Р±СѓРґРµС‚ РїСЂРѕРїСѓС‰РµРЅР° РґРѕ РїРѕСЏРІР»РµРЅРёСЏ РїРµСЂРІРѕРіРѕ РєР°РґСЂР°.
- Р•СЃР»Рё С…РѕС‚РёС‚Рµ РѕС‚РїСЂР°РІР»СЏС‚СЊ РєРѕРјР°РЅРґС‹ СЃСЂР°Р·Сѓ, Р·Р°РґР°Р№С‚Рµ `cloud_prefix` СЏРІРЅРѕ вЂ” С‚РѕРіРґР° Р±СѓРґРµС‚ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊСЃСЏ С‚РѕР»СЊРєРѕ РѕРЅ.

Secrets
- Р’ РїРѕР»СЏС… `mqtt.user/password` Рё `ha_mqtt.user/password` РјРѕР¶РЅРѕ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ `!secret KEY`.
- Р—РЅР°С‡РµРЅРёСЏ С‡РёС‚Р°СЋС‚СЃСЏ РёР· С„Р°Р№Р»Р° `/config/secrets.yaml` (С‡РµСЂРµР· Supervisor Сѓ Р°РґРґРѕРЅР° РµСЃС‚СЊ РґРѕСЃС‚СѓРї Рє `/config`).
- Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅРѕ РїРѕРґРґРµСЂР¶РёРІР°РµС‚СЃСЏ РµРґРёРЅР°СЏ Р·Р°РїРёСЃСЊ `mqtt_server: mqtt://<host>:<port>` вЂ” РїСЂРё РЅР°Р»РёС‡РёРё РїРµСЂРµРѕРїСЂРµРґРµР»СЏРµС‚ `ha_mqtt.host/port`.
- РџСЂРёРјРµСЂ `secrets.yaml`:
```
mqtt_username: myuser
mqtt_password: mypass
mqtt_server: mqtt://core-mosquitto:1883
```

РЎРµС‚РµРІРѕРµ РІР·Р°РёРјРѕРґРµР№СЃС‚РІРёРµ
- Р›РѕРєР°Р»СЊРЅС‹Р№ Mosquitto СЃР»СѓС€Р°РµС‚ `listen_port` (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ 2883) РІРЅСѓС‚СЂРё РєРѕРЅС‚РµР№РЅРµСЂР° Р°РґРґРѕРЅР°.
- Р‘СЂРёРґР¶ РІ HA РЅР°СЃС‚СЂР°РёРІР°РµС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РїСЂРё РЅР°Р»РёС‡РёРё `ha_mqtt.user/password` Рё РїСѓР±Р»РёРєСѓРµС‚:
  - РСЃС…РѕРґСЏС‰РёРµ РІ HA: `<topic_prefix>/#` Рё `<discovery_prefix>/#`.
  - Р’С…РѕРґСЏС‰РёРµ РёР· HA РІ Р»РѕРєР°Р»СЊРЅС‹Р№: `<topic_prefix>/+/cmd/#` (РєРѕРјР°РЅРґС‹ РґР»СЏ СѓСЃС‚СЂРѕР№СЃС‚РІР°).
- Р РµРєРѕРјРµРЅРґСѓРµРјС‹Р№ С…РѕСЃС‚ HA MQTT: `core-mosquitto`; РїРѕСЂС‚: `1883`.

РћСЃРЅРѕРІРЅС‹Рµ С‚РѕРїРёРєРё
- Р’С…РѕРґ СѓСЃС‚СЂРѕР№СЃС‚РІР°: `CLOUD_PREFIX/<MAC>/from` (СЃС‹СЂС‹Рµ РєР°РґСЂС‹ Neptun).
- РџСѓР±Р»РёРєР°С†РёРё СЃРѕСЃС‚РѕСЏРЅРёСЏ: `TOPIC_PREFIX/<MAC>/**` (СЃРµРЅСЃРѕСЂС‹, СЃС‡РµС‚С‡РёРєРё, СЃРѕСЃС‚РѕСЏРЅРёСЏ).
- РљРѕРјР°РЅРґС‹ РёР· HA: `TOPIC_PREFIX/<MAC>/cmd/valve/set` СЃРѕ Р·РЅР°С‡РµРЅРёСЏРјРё `1/0` (`ON/OFF`, `OPEN/CLOSE`).
- MQTT Discovery РїСѓР±Р»РёРєСѓРµС‚СЃСЏ РїРѕРґ `DISCOVERY_PREFIX/**`.

РџСЂРёРјРµС‡Р°РЅРёСЏ
- Р”Р»СЏ СЂР°Р±РѕС‚С‹ Р±РµР· СЃС‚РѕСЂРѕРЅРЅРµРіРѕ Р±СЂРѕРєРµСЂР° СѓСЃС‚СЂРѕР№СЃС‚РІРѕ Neptun РґРѕР»Р¶РЅРѕ СѓРјРµС‚СЊ РїРѕРґРєР»СЋС‡Р°С‚СЊСЃСЏ Рє Р»РѕРєР°Р»СЊРЅРѕРјСѓ Р±СЂРѕРєРµСЂСѓ Р°РґРґРѕРЅР°.
- Р•СЃР»Рё Р»РѕРєР°Р»СЊРЅС‹Р№ Р±СЂРѕРєРµСЂ РЅСѓР¶РЅРѕ Р·Р°С‰РёС‚РёС‚СЊ, Р·Р°РґР°Р№С‚Рµ `mqtt.user/password` Рё `allow_anonymous: false`.
- РћС‚Р»Р°РґРєР°: РІРєР»СЋС‡РёС‚Рµ `bridge.debug: true` вЂ” Р°РґРґРѕРЅ РЅР°С‡РЅРµС‚ РїРµС‡Р°С‚Р°С‚СЊ РїРѕРґСЂРѕР±РЅС‹Рµ СЃРѕРѕР±С‰РµРЅРёСЏ РІ Р»РѕРі.


## Дополнения к функциональности (актуально для 0.1.45)

Ниже перечислено, что добавлено/уточнено по сравнению с ранними версиями. Эти пункты не меняют порядок установки и общие принципы работы, а дополняют их.

- Управление (HA entities):
  - Переключатель клапана `Valve` (cmd `neptun/<MAC>/cmd/valve/set`, state `neptun/<MAC>/state/valve_open`).
  - Переключатель `Floor Wash` (бывший Dry Flag) — включает/выключает сухой режим контроллера (cmd `.../cmd/dry_flag/set`, state `.../settings/dry_flag`).
  - Переключатель `Close On Offline` — закрывать кран при потере датчиков (cmd `.../cmd/close_on_offline/set`, state `.../settings/close_valve_flag`).
  - Селект `Line i Type (1..4)` — тип входа линии (sensor/counter) (cmd `.../cmd/line_i_type/set`, state `.../settings/lines_in/line_i`).
  - Числовые поля (mode=box):
    - `Line i Counter (set)` — установка счётчика в литрах (cmd `.../cmd/counters/line_i/value/set`).
    - `Line i Step (set)` — шаг в L/импульс (cmd `.../cmd/counters/line_i/step/set`).

- Сенсоры:
  - `Module Status` (текстовое описание статуса модуля) — `neptun/<MAC>/state/status_name`.
  - `Module Alert` (binary, device_class: problem) — включается при любом проблемном бите статуса — `neptun/<MAC>/settings/status/module_alert` (yes/no).
  - `Device Time` (timestamp) — время контроллера из TLV 0x44; публикуется как ISO UTC с учётом локального часового пояса.
  - `Device Time Drift` (diagnostic) — разница между локальными часами хоста и временем устройства, сек — `neptun/<MAC>/device_time_drift_seconds`.
  - `Module Lost` (binary, problem) — yes, если не было данных более 60 секунд. Предпочтительно используется время из TLV 0x44; при его отсутствии — время получения кадра.

- Протокол/обработка:
  - Поддерживаются кадры 0x52 (system_state), 0x53 (sensor_state), 0x57 (settings), 0x43 (counters).
  - TLV 0x44 — время устройства: приходит в локальном времени; конвертируем в UTC, публикуем ISO и epoch, считаем дрейф.
  - Батарея беспроводных датчиков: значения > 200 (похоже на «вольтовую шкалу») отбрасываются и не публикуются; валидные проценты 0..100 — публикуются.
  - Запись счётчиков: формируется кадр 0x57/0x43 на `<cloud_prefix>/<MAC>/to`; для не изменяемых линий подставляются последние известные «сырые» значения/шаги.

- Диагностика:
  - Включение `NB_DEBUG=true` добавляет расширенные логи подписки/публикаций.
  - «Raw» кадры публикуются в `neptun/<MAC>/raw/*`, а также сгруппированы по типу и имени (`raw/by_type/*`, `raw/by_name/*`).

> Важно: настройка Wi?Fi самого Neptun не производится через MQTT. Используйте штатное приложение/режим точки доступа.

## Краткая история изменений

- 0.1.45 — корректная обработка `device_time` как локального времени; исправлен deprecation `utcfromtimestamp`.
- 0.1.44 — добавлены сенсоры `Module Status` (текст) и `Module Alert` (binary).
- 0.1.41–0.1.43 — `Module Lost`, парсинг TLV 0x44 (время), `Device Time Drift` и сопутствующие улучшения.
- 0.1.36–0.1.39 — единый переключатель `Valve`, переименование Dry Flag > `Floor Wash`, числовые поля ввода для счётчика и шага.
